<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GridTube</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Bebas+Neue&family=DM+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--bg:#080809;--panel:#0f0f12;--border:#1c1c24;--red:#ff2d2d;--gold:#f5a623;--green:#00c864;--text:#f0f0f5;--muted:#44445a;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;display:flex;flex-direction:column;}

/* PAGES */
.page{display:none;align-items:center;justify-content:center;min-height:100vh;padding:24px 20px;flex-direction:column;}
.page.active{display:flex;}
.page-logo{font-family:'Bebas Neue',sans-serif;font-size:2.6rem;letter-spacing:3px;margin-bottom:6px;text-align:center;}
.page-logo span{color:var(--red);}
.page-sub{font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:36px;text-align:center;}

/* AUTH */
.auth-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:40px 36px;width:100%;max-width:400px;animation:fadeUp 0.4s ease;}
.auth-tabs{display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:28px;}
.auth-tab{flex:1;padding:10px;background:transparent;border:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s;}
.auth-tab.active{background:var(--red);color:#fff;}
.field{margin-bottom:16px;}
.field label{display:block;font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.field input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:11px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.88rem;outline:none;transition:border-color 0.2s;}
.field input:focus{border-color:var(--red);}
.submit-btn{width:100%;padding:13px;background:var(--red);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;margin-top:6px;transition:all 0.18s;}
.submit-btn:hover{background:#e02020;transform:translateY(-1px);}
.submit-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.msg{margin-top:14px;padding:11px 14px;border-radius:8px;font-family:'DM Mono',monospace;font-size:0.75rem;line-height:1.5;display:none;}
.msg.error{background:rgba(255,45,45,0.1);border:1px solid rgba(255,45,45,0.3);color:#ff6b6b;display:block;}
.msg.success{background:rgba(0,200,100,0.08);border:1px solid rgba(0,200,100,0.25);color:#00c864;display:block;}

/* PLANS */
.plans-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;width:100%;max-width:720px;animation:fadeUp 0.4s ease;}
@media(max-width:560px){.plans-grid{grid-template-columns:1fr;}}
.plan-card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:32px 28px;display:flex;flex-direction:column;gap:20px;position:relative;transition:border-color 0.2s,transform 0.2s;}
.plan-card:hover{transform:translateY(-3px);}
.plan-card.featured{border-color:var(--gold);box-shadow:0 0 30px rgba(245,166,35,0.08);}
.plan-badge{position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--gold);color:#000;font-family:'DM Mono',monospace;font-size:0.65rem;font-weight:500;padding:4px 14px;border-radius:999px;letter-spacing:1px;text-transform:uppercase;white-space:nowrap;}
.plan-name{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:2px;}
.plan-price{display:flex;align-items:baseline;gap:4px;}
.plan-price .currency{font-family:'DM Mono',monospace;font-size:0.9rem;color:var(--muted);}
.plan-price .amount{font-family:'Bebas Neue',sans-serif;font-size:3rem;line-height:1;}
.plan-card.featured .amount{color:var(--gold);}
.plan-card:not(.featured) .amount{color:var(--red);}
.plan-price .period{font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);}
.plan-features{list-style:none;display:flex;flex-direction:column;gap:10px;flex:1;}
.plan-features li{display:flex;align-items:center;gap:10px;font-size:0.88rem;}
.check{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.65rem;}
.plan-card:not(.featured) .check{background:rgba(255,45,45,0.15);color:var(--red);}
.plan-card.featured .check{background:rgba(245,166,35,0.15);color:var(--gold);}
.plan-btn{width:100%;padding:13px;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;transition:all 0.18s;}
.plan-card:not(.featured) .plan-btn{background:var(--red);color:#fff;}
.plan-card:not(.featured) .plan-btn:hover{background:#e02020;transform:translateY(-1px);}
.plan-card.featured .plan-btn{background:var(--gold);color:#000;}
.plan-card.featured .plan-btn:hover{background:#e09500;transform:translateY(-1px);}
.plan-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important;}
.plans-note{margin-top:20px;font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);text-align:center;line-height:1.7;}
.plans-note a{color:var(--red);cursor:pointer;text-decoration:underline;}
.expired-banner{background:rgba(255,45,45,0.08);border:1px solid rgba(255,45,45,0.25);border-radius:10px;padding:16px 20px;text-align:center;margin-bottom:24px;max-width:720px;width:100%;}
.expired-banner p{font-family:'DM Mono',monospace;font-size:0.8rem;color:#ff6b6b;line-height:1.6;}

/* ADMIN PAGE */
#pageAdmin{min-height:100vh;display:none;flex-direction:column;}
#pageAdmin.active{display:flex;}
.admin-topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:var(--panel);border-bottom:1px solid var(--border);}
.admin-logo{font-family:'Bebas Neue',sans-serif;font-size:1.7rem;letter-spacing:2px;}
.admin-logo span{color:var(--gold);}
.admin-badge{background:rgba(245,166,35,0.15);color:var(--gold);border:1px solid rgba(245,166,35,0.3);font-family:'DM Mono',monospace;font-size:0.65rem;padding:3px 10px;border-radius:999px;letter-spacing:1px;text-transform:uppercase;}
.admin-actions{display:flex;align-items:center;gap:12px;}
.admin-body{padding:32px 28px;flex:1;}
.admin-title{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;margin-bottom:6px;}
.admin-subtitle{font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);margin-bottom:28px;}
.admin-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:32px;}
.stat-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px 22px;}
.stat-val{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;line-height:1;margin-bottom:4px;}
.stat-val.red{color:var(--red);}
.stat-val.gold{color:var(--gold);}
.stat-val.green{color:var(--green);}
.stat-val.muted{color:var(--muted);}
.stat-label{font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}

/* TABLE */
.table-wrap{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.table-header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);}
.table-title{font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.search-input{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:7px 12px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.78rem;outline:none;transition:border-color 0.2s;width:220px;}
.search-input:focus{border-color:var(--gold);}
table{width:100%;border-collapse:collapse;}
thead th{padding:12px 20px;text-align:left;font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.15s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:rgba(255,255,255,0.02);}
tbody td{padding:14px 20px;font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--text);vertical-align:middle;}
.td-email{max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.td-date{color:var(--muted);font-size:0.72rem;}

.status-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:999px;font-size:0.65rem;font-weight:500;letter-spacing:0.5px;white-space:nowrap;}
.status-badge.active-plan{background:rgba(0,200,100,0.12);border:1px solid rgba(0,200,100,0.25);color:var(--green);}
.status-badge.expired{background:rgba(255,45,45,0.1);border:1px solid rgba(255,45,45,0.25);color:#ff6b6b;}
.status-badge.no-plan{background:rgba(68,68,90,0.3);border:1px solid var(--border);color:var(--muted);}
.status-badge.plan-pro{background:rgba(245,166,35,0.12);border:1px solid rgba(245,166,35,0.3);color:var(--gold);}
.status-badge.plan-basic{background:rgba(255,45,45,0.1);border:1px solid rgba(255,45,45,0.25);color:var(--red);}

.days-badge{font-family:'DM Mono',monospace;font-size:0.72rem;}
.days-badge.ok{color:var(--green);}
.days-badge.warn{color:var(--gold);}
.days-badge.exp{color:#ff6b6b;}
.days-badge.none{color:var(--muted);}

.grant-wrap{display:flex;gap:6px;align-items:center;}
.grant-btn{padding:5px 12px;border:none;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:700;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.grant-btn.basic{background:rgba(255,45,45,0.15);color:var(--red);border:1px solid rgba(255,45,45,0.3);}
.grant-btn.basic:hover{background:var(--red);color:#fff;}
.grant-btn.pro{background:rgba(245,166,35,0.15);color:var(--gold);border:1px solid rgba(245,166,35,0.3);}
.grant-btn.pro:hover{background:var(--gold);color:#000;}
.grant-btn:disabled{opacity:0.4;cursor:not-allowed;}

.loading-row td{text-align:center;padding:40px;color:var(--muted);font-family:'DM Mono',monospace;font-size:0.8rem;}
.empty-row td{text-align:center;padding:40px;color:var(--muted);font-family:'DM Mono',monospace;font-size:0.78rem;}

/* APP */
#app{display:none;flex-direction:column;flex:1;}
.topbar{display:flex;align-items:center;gap:20px;padding:12px 24px;background:var(--panel);border-bottom:1px solid var(--border);flex-wrap:wrap;position:sticky;top:0;z-index:100;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:2px;flex-shrink:0;}
.logo span{color:var(--red);}
.input-wrap{flex:1;min-width:200px;display:flex;align-items:center;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0 12px;gap:8px;transition:border-color 0.2s;}
.input-wrap:focus-within{border-color:var(--red);}
#urlInput{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Mono',monospace;font-size:0.8rem;padding:9px 0;}
#urlInput::placeholder{color:var(--muted);}
.controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.ctrl-group{display:flex;align-items:center;gap:5px;}
.ctrl-label{font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.num-btn{width:24px;height:24px;background:var(--border);border:none;border-radius:5px;color:var(--text);font-size:0.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.15s;}
.num-btn:hover{background:var(--red);}
.num-val{font-family:'DM Mono',monospace;font-size:0.95rem;font-weight:500;color:var(--red);min-width:26px;text-align:center;}
.btn{padding:8px 16px;border:none;border-radius:7px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.82rem;cursor:pointer;transition:all 0.18s;}
.btn-primary{background:var(--red);color:#fff;}
.btn-primary:hover{background:#e02020;transform:translateY(-1px);}
.btn-outline{background:transparent;color:var(--muted);border:1px solid var(--border);}
.btn-outline:hover{border-color:var(--red);color:var(--red);}
.btn-admin{background:rgba(245,166,35,0.15);color:var(--gold);border:1px solid rgba(245,166,35,0.3);padding:7px 14px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all 0.18s;}
.btn-admin:hover{background:var(--gold);color:#000;}
.user-info{display:flex;align-items:center;gap:8px;margin-left:auto;}
.plan-pill{font-family:'DM Mono',monospace;font-size:0.65rem;padding:3px 10px;border-radius:999px;font-weight:500;letter-spacing:1px;text-transform:uppercase;}
.plan-pill.basic{background:rgba(255,45,45,0.15);color:var(--red);border:1px solid rgba(255,45,45,0.3);}
.plan-pill.pro{background:rgba(245,166,35,0.15);color:var(--gold);border:1px solid rgba(245,166,35,0.3);}
.user-email{font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--muted);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-sm{padding:5px 12px;font-size:0.75rem;border-radius:6px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;transition:all 0.18s;}
.btn-sm:hover{border-color:var(--red);color:var(--red);}
.timerbar-wrap{height:3px;background:var(--border);overflow:hidden;}
.timerbar{height:100%;background:var(--red);width:100%;transition:width 1s linear;}
.statusbar{display:flex;align-items:center;gap:14px;padding:6px 24px;background:var(--panel);border-bottom:1px solid var(--border);font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);}
.dot{width:7px;height:7px;border-radius:50%;background:var(--muted);flex-shrink:0;}
.dot.live{background:var(--red);animation:blink 1.4s infinite;}
.status-text{color:var(--text);}
.status-countdown{color:var(--red);font-weight:500;margin-left:auto;}
.grid-area{flex:1;padding:16px;display:grid;gap:10px;align-content:start;}
.player-cell{background:#000;border-radius:10px;overflow:hidden;position:relative;aspect-ratio:16/9;border:1px solid var(--border);transition:border-color 0.2s;animation:fadeIn 0.4s ease both;}
.player-cell:hover{border-color:var(--red);}
.player-cell iframe{width:100%;height:100%;border:none;display:block;}
.cell-badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.1);color:#fff;font-family:'DM Mono',monospace;font-size:0.63rem;padding:3px 8px;border-radius:4px;pointer-events:none;}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:14px;color:var(--muted);padding:60px 20px;}
.empty svg{opacity:0.2;}
.empty p{font-family:'DM Mono',monospace;font-size:0.82rem;text-align:center;line-height:1.8;}
.limit-notice{background:rgba(255,45,45,0.08);border:1px solid rgba(255,45,45,0.2);border-radius:8px;padding:10px 16px;font-family:'DM Mono',monospace;font-size:0.72rem;color:#ff6b6b;margin:12px 16px 0;display:none;}

/* TOAST */
.toast{position:fixed;bottom:28px;right:28px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px 20px;font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--text);box-shadow:0 8px 30px rgba(0,0,0,0.4);transform:translateY(20px);opacity:0;transition:all 0.3s;z-index:999;pointer-events:none;max-width:320px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{border-color:rgba(0,200,100,0.4);color:var(--green);}
.toast.err{border-color:rgba(255,45,45,0.4);color:#ff6b6b;}

@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
@keyframes fadeIn{from{opacity:0;transform:scale(0.97)}to{opacity:1;transform:scale(1)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<!-- AUTH -->
<div class="page active" id="pageAuth">
  <div class="page-logo">Grid<span>Tube</span></div>
  <div class="page-sub">acesse sua conta</div>
  <div class="auth-box">
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="switchTab('login')">Entrar</button>
      <button class="auth-tab" id="tabRegister" onclick="switchTab('register')">Criar conta</button>
    </div>
    <div id="formLogin">
      <div class="field"><label>E-mail</label><input type="email" id="loginEmail" placeholder="seu@email.com"/></div>
      <div class="field"><label>Senha</label><input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
      <button class="submit-btn" id="loginBtn" onclick="doLogin()">Entrar</button>
      <div class="msg" id="loginMsg"></div>
    </div>
    <div id="formRegister" style="display:none">
      <div class="field"><label>E-mail</label><input type="email" id="regEmail" placeholder="seu@email.com"/></div>
      <div class="field"><label>Senha</label><input type="password" id="regPass" placeholder="m√≠nimo 6 caracteres"/></div>
      <div class="field"><label>Confirmar senha</label><input type="password" id="regPass2" placeholder="repita a senha"/></div>
      <button class="submit-btn" id="registerBtn" onclick="doRegister()">Criar conta</button>
      <div class="msg" id="registerMsg"></div>
    </div>
  </div>
</div>

<!-- PLANS -->
<div class="page" id="pagePlans">
  <div class="page-logo">Grid<span>Tube</span></div>
  <div class="page-sub">escolha seu plano</div>
  <div id="expiredBanner" class="expired-banner" style="display:none">
    <p>‚ö†Ô∏è Seu plano expirou. Renove abaixo para continuar usando o GridTube.</p>
  </div>
  <div class="plans-grid">
    <div class="plan-card">
      <div class="plan-name">B√°sico</div>
      <div class="plan-price"><span class="currency">R$</span><span class="amount">19</span><span class="currency">,90</span><span class="period">/ 30 dias</span></div>
      <ul class="plan-features">
        <li><span class="check">‚úì</span> At√© 4 janelas simult√¢neas</li>
        <li><span class="check">‚úì</span> Refresh autom√°tico</li>
        <li><span class="check">‚úì</span> Suporte a YouTube Shorts</li>
        <li><span class="check">‚úì</span> Intervalo m√≠nimo de 10s</li>
      </ul>
      <button class="plan-btn" id="btnBasico" onclick="selectPlan('basico')">Assinar B√°sico</button>
    </div>
    <div class="plan-card featured">
      <div class="plan-badge">‚≠ê Mais popular</div>
      <div class="plan-name">Pro</div>
      <div class="plan-price"><span class="currency">R$</span><span class="amount">39</span><span class="currency">,90</span><span class="period">/ 30 dias</span></div>
      <ul class="plan-features">
        <li><span class="check">‚úì</span> At√© 16 janelas simult√¢neas</li>
        <li><span class="check">‚úì</span> Refresh autom√°tico</li>
        <li><span class="check">‚úì</span> Suporte a YouTube Shorts</li>
        <li><span class="check">‚úì</span> Intervalo m√≠nimo de 5s</li>
      </ul>
      <button class="plan-btn" id="btnPro" onclick="selectPlan('pro')">Assinar Pro</button>
    </div>
  </div>
  <div class="plans-note">Planos v√°lidos por 30 dias ap√≥s a ativa√ß√£o.<br><a onclick="doLogout()">Sair da conta</a></div>
</div>

<!-- ADMIN -->
<div id="pageAdmin">
  <div class="admin-topbar">
    <div style="display:flex;align-items:center;gap:14px;">
      <div class="admin-logo">Grid<span>Tube</span></div>
      <span class="admin-badge">‚ö° Admin</span>
    </div>
    <div class="admin-actions">
      <span id="adminEmail" style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);"></span>
      <button class="btn-sm" onclick="goToApp()">‚Üí Ir para o app</button>
      <button class="btn-sm" onclick="doLogout()">Sair</button>
    </div>
  </div>

  <div class="admin-body">
    <div class="admin-title">Painel de Controle</div>
    <div class="admin-subtitle">Gerencie usu√°rios e assinaturas</div>

    <div class="admin-stats">
      <div class="stat-card"><div class="stat-val red" id="statTotal">‚Äî</div><div class="stat-label">Total de usu√°rios</div></div>
      <div class="stat-card"><div class="stat-val green" id="statActive">‚Äî</div><div class="stat-label">Assinaturas ativas</div></div>
      <div class="stat-card"><div class="stat-val gold" id="statPro">‚Äî</div><div class="stat-label">Plano Pro</div></div>
      <div class="stat-card"><div class="stat-val muted" id="statExpired">‚Äî</div><div class="stat-label">Expiradas / Sem plano</div></div>
    </div>

    <div class="table-wrap">
      <div class="table-header">
        <span class="table-title">Usu√°rios cadastrados</span>
        <input class="search-input" id="searchInput" placeholder="üîç Buscar por e-mail..." oninput="filterTable()"/>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>E-mail</th>
              <th>Cadastro</th>
              <th>Plano atual</th>
              <th>Expira em</th>
              <th>Liberar plano</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr class="loading-row"><td colspan="5">Carregando usu√°rios...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="logo">Grid<span>Tube</span></div>
    <div class="input-wrap">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
      </svg>
      <input type="text" id="urlInput" placeholder="https://www.youtube.com/watch?v=... ou /shorts/..."/>
    </div>
    <div class="controls">
      <div class="ctrl-group">
        <span class="ctrl-label">Janelas</span>
        <button class="num-btn" onclick="change('windows',-1)">‚àí</button>
        <span class="num-val" id="windowsVal">4</span>
        <button class="num-btn" onclick="change('windows',1)">+</button>
      </div>
      <div class="ctrl-group">
        <span class="ctrl-label">Refresh (s)</span>
        <button class="num-btn" onclick="change('timer',-5)">‚àí</button>
        <span class="num-val" id="timerVal">60</span>
        <button class="num-btn" onclick="change('timer',5)">+</button>
      </div>
      <button class="btn btn-primary" onclick="launch()">‚ñ∂ Iniciar</button>
      <button class="btn btn-outline" onclick="stopAll()">‚ñ† Parar</button>
    </div>
    <div class="user-info">
      <span class="plan-pill" id="planPill"></span>
      <span class="user-email" id="userEmail"></span>
      <button id="adminBtn" class="btn-admin" onclick="goToAdmin()" style="display:none;">‚ö° Admin</button>
      <button class="btn-sm" onclick="doLogout()">Sair</button>
    </div>
  </div>
  <div class="timerbar-wrap"><div class="timerbar" id="timerbar"></div></div>
  <div class="statusbar">
    <div class="dot" id="dot"></div>
    <span class="status-text" id="statusText">Aguardando URL...</span>
    <span class="status-countdown" id="countdown"></span>
  </div>
  <div class="limit-notice" id="limitNotice"></div>
  <div style="display:flex;flex:1;flex-direction:column;">
    <div class="empty" id="emptyState">
      <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="2" y="3" width="20" height="14" rx="2"/>
        <path d="M8 21h8M12 17v4"/>
        <path d="M10 8l6 3.5-6 3.5V8z" fill="currentColor"/>
      </svg>
      <p>Cole um link do YouTube acima<br>e clique em <strong style="color:#f0f0f5">‚ñ∂ Iniciar</strong></p>
    </div>
    <div class="grid-area" id="grid" style="display:none;"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
const {createClient}=supabase;
const sb=createClient(
  'https://uxswlqukmapgawwtlxwl.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4c3dscXVrbWFwZ2F3d3RseHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMzk0MTYsImV4cCI6MjA4NzgxNTQxNn0.JEW_clhwUfNiSsQG3_S_GcDBf2gJSE5WiBYvzBJfAPo'
);

let currentUser=null,currentPlan=null,isAdmin=false;
let allUsersData=[];
const LIMITS={basico:{maxWindows:4,minTimer:10},pro:{maxWindows:16,minTimer:5}};

// ‚îÄ‚îÄ Auth listener ‚îÄ‚îÄ
sb.auth.onAuthStateChange(async(event,session)=>{
  if(session){currentUser=session.user;await checkAdmin();}
  else{currentUser=null;currentPlan=null;isAdmin=false;showPage('auth');}
});

async function checkAdmin(){
  const{data}=await sb.from('admins').select('user_id').eq('user_id',currentUser.id).single();
  isAdmin=!!data;
  if(isAdmin){
    document.getElementById('adminBtn').style.display='flex';
    await loadAdminPanel();
  } else {
    await checkSubscription();
  }
}

// ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ
function showPage(page){
  document.getElementById('pageAuth').classList.toggle('active',page==='auth');
  document.getElementById('pagePlans').classList.toggle('active',page==='plans');
  document.getElementById('pageAdmin').classList.toggle('active',page==='admin');
  document.getElementById('app').style.display=page==='app'?'flex':'none';
}

function goToAdmin(){showPage('admin');}
function goToApp(){
  if(currentPlan)showApp();
  else checkSubscription();
}

// ‚îÄ‚îÄ SUBSCRIPTION ‚îÄ‚îÄ
async function checkSubscription(){
  const{data,error}=await sb.from('subscriptions').select('*').eq('user_id',currentUser.id).order('expires_at',{ascending:false}).limit(1).single();
  if(error||!data){showPage('plans');return;}
  const now=new Date(),expires=new Date(data.expires_at);
  if(expires<now){document.getElementById('expiredBanner').style.display='block';showPage('plans');}
  else{currentPlan=data.plan;showApp();}
}

async function selectPlan(plan){
  const btnId=plan==='basico'?'btnBasico':'btnPro';
  const btn=document.getElementById(btnId);
  btn.disabled=true;btn.textContent='Ativando...';
  const now=new Date(),expires=new Date(now.getTime()+30*24*60*60*1000);
  const{error}=await sb.from('subscriptions').insert({user_id:currentUser.id,plan,started_at:now.toISOString(),expires_at:expires.toISOString()});
  btn.disabled=false;btn.textContent=plan==='basico'?'Assinar B√°sico':'Assinar Pro';
  if(error){alert('Erro ao ativar plano.');return;}
  currentPlan=plan;showApp();
}

function showApp(){
  showPage('app');
  const lim=LIMITS[currentPlan]||LIMITS.basico;
  windowsCount=Math.min(windowsCount,lim.maxWindows);
  timerSecs=Math.max(timerSecs,lim.minTimer);
  document.getElementById('windowsVal').textContent=windowsCount;
  document.getElementById('timerVal').textContent=timerSecs;
  const pill=document.getElementById('planPill');
  pill.textContent=currentPlan==='pro'?'Pro':'B√°sico';
  pill.className='plan-pill '+(currentPlan==='pro'?'pro':'basic');
  document.getElementById('userEmail').textContent=currentUser.email;
  if(isAdmin)document.getElementById('adminBtn').style.display='inline-flex';
}

// ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ
async function loadAdminPanel(){
  showPage('admin');
  document.getElementById('adminEmail').textContent=currentUser.email;

  // Busca todos os usu√°rios via view
  const{data:users,error:uErr}=await sb.from('public_users').select('*').order('created_at',{ascending:false});
  if(uErr||!users){
    document.getElementById('usersTableBody').innerHTML=`<tr class="empty-row"><td colspan="5">Erro ao carregar usu√°rios: ${uErr?.message||'verifique o SQL da view'}</td></tr>`;
    return;
  }

  // Busca todas as subscriptions
  const{data:subs}=await sb.from('subscriptions').select('*').order('expires_at',{ascending:false});

  // Monta mapa user_id -> subscription mais recente
  const subMap={};
  if(subs){
    subs.forEach(s=>{
      if(!subMap[s.user_id])subMap[s.user_id]=s;
    });
  }

  allUsersData=users.map(u=>({...u,sub:subMap[u.id]||null}));
  updateStats(allUsersData);
  renderTable(allUsersData);
}

function updateStats(data){
  const now=new Date();
  let active=0,pro=0,inactive=0;
  data.forEach(u=>{
    if(!u.sub||new Date(u.sub.expires_at)<now)inactive++;
    else{active++;if(u.sub.plan==='pro')pro++;}
  });
  document.getElementById('statTotal').textContent=data.length;
  document.getElementById('statActive').textContent=active;
  document.getElementById('statPro').textContent=pro;
  document.getElementById('statExpired').textContent=inactive;
}

function renderTable(data){
  const now=new Date();
  const tbody=document.getElementById('usersTableBody');
  if(!data.length){
    tbody.innerHTML=`<tr class="empty-row"><td colspan="5">Nenhum usu√°rio encontrado.</td></tr>`;
    return;
  }

  tbody.innerHTML=data.map(u=>{
    const sub=u.sub;
    const created=new Date(u.created_at).toLocaleDateString('pt-BR');
    let planBadge,daysBadge,daysLeft='';

    if(!sub){
      planBadge=`<span class="status-badge no-plan">Sem plano</span>`;
      daysBadge=`<span class="days-badge none">‚Äî</span>`;
    } else {
      const expires=new Date(sub.expires_at);
      const diff=Math.ceil((expires-now)/(1000*60*60*24));
      if(diff<=0){
        planBadge=`<span class="status-badge expired">Expirado</span>`;
        daysBadge=`<span class="days-badge exp">Expirado</span>`;
      } else {
        const cls=sub.plan==='pro'?'plan-pro':'plan-basic';
        const label=sub.plan==='pro'?'Pro':'B√°sico';
        planBadge=`<span class="status-badge ${cls}">${label}</span>`;
        const dc=diff<=5?'exp':diff<=10?'warn':'ok';
        daysBadge=`<span class="days-badge ${dc}">${diff} dia${diff!==1?'s':''}</span>`;
      }
    }

    return `<tr>
      <td class="td-email" title="${u.email}">${u.email}</td>
      <td class="td-date">${created}</td>
      <td>${planBadge}</td>
      <td>${daysBadge}</td>
      <td>
        <div class="grant-wrap">
          <button class="grant-btn basic" onclick="grantPlan('${u.id}','${u.email}','basico',this)">B√°sico</button>
          <button class="grant-btn pro" onclick="grantPlan('${u.id}','${u.email}','pro',this)">Pro</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function filterTable(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  const filtered=allUsersData.filter(u=>u.email.toLowerCase().includes(q));
  renderTable(filtered);
}

async function grantPlan(userId,email,plan,btn){
  btn.disabled=true;
  const row=btn.closest('tr');
  row.querySelectorAll('.grant-btn').forEach(b=>b.disabled=true);

  const now=new Date(),expires=new Date(now.getTime()+30*24*60*60*1000);
  const{error}=await sb.from('subscriptions').insert({
    user_id:userId,plan,
    started_at:now.toISOString(),
    expires_at:expires.toISOString()
  });

  if(error){
    showToast(`Erro ao liberar plano: ${error.message}`,'err');
    row.querySelectorAll('.grant-btn').forEach(b=>b.disabled=false);
    return;
  }

  showToast(`‚úì Plano ${plan==='pro'?'Pro':'B√°sico'} liberado para ${email}`,'ok');
  // Atualiza local
  const user=allUsersData.find(u=>u.id===userId);
  if(user)user.sub={plan,started_at:now.toISOString(),expires_at:expires.toISOString(),user_id:userId};
  updateStats(allUsersData);

  // Re-renderiza linha
  const q=document.getElementById('searchInput').value.toLowerCase();
  renderTable(allUsersData.filter(u=>u.email.toLowerCase().includes(q)));
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
let toastTimer=null;
function showToast(msg,type='ok'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast '+type+' show';
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),3500);
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function switchTab(tab){
  const isL=tab==='login';
  document.getElementById('formLogin').style.display=isL?'block':'none';
  document.getElementById('formRegister').style.display=isL?'none':'block';
  document.getElementById('tabLogin').classList.toggle('active',isL);
  document.getElementById('tabRegister').classList.toggle('active',!isL);
}

async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  const msg=document.getElementById('loginMsg');
  const btn=document.getElementById('loginBtn');
  if(!email||!pass){showMsg(msg,'Preencha e-mail e senha.','error');return;}
  btn.disabled=true;btn.textContent='Entrando...';
  const{error}=await sb.auth.signInWithPassword({email,password:pass});
  btn.disabled=false;btn.textContent='Entrar';
  if(error)showMsg(msg,traduzirErro(error.message),'error');
}

async function doRegister(){
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPass').value;
  const pass2=document.getElementById('regPass2').value;
  const msg=document.getElementById('registerMsg');
  const btn=document.getElementById('registerBtn');
  if(!email||!pass){showMsg(msg,'Preencha todos os campos.','error');return;}
  if(pass!==pass2){showMsg(msg,'As senhas n√£o coincidem.','error');return;}
  if(pass.length<6){showMsg(msg,'Senha deve ter pelo menos 6 caracteres.','error');return;}
  btn.disabled=true;btn.textContent='Criando conta...';
  const{error}=await sb.auth.signUp({email,password:pass});
  btn.disabled=false;btn.textContent='Criar conta';
  if(error)showMsg(msg,traduzirErro(error.message),'error');
  else showMsg(msg,'‚úì Conta criada! Verifique seu e-mail para confirmar.','success');
}

async function doLogout(){stopAll(true);await sb.auth.signOut();}

function showMsg(el,text,type){el.textContent=text;el.className='msg '+type;}
function traduzirErro(msg){
  if(msg.includes('Invalid login'))return 'E-mail ou senha incorretos.';
  if(msg.includes('Email not confirmed'))return 'Confirme seu e-mail antes de entrar.';
  if(msg.includes('already registered'))return 'Este e-mail j√° est√° cadastrado.';
  if(msg.includes('Password should'))return 'Senha deve ter pelo menos 6 caracteres.';
  return msg;
}

// ‚îÄ‚îÄ PLAYER ‚îÄ‚îÄ
let windowsCount=4,timerSecs=60,tickId=null,remaining=0,refreshTotal=0;

function change(type,delta){
  const lim=LIMITS[currentPlan]||LIMITS.basico;
  if(type==='windows'){
    const next=windowsCount+delta;
    if(next<1)return;
    if(next>lim.maxWindows){showLimitNotice(`Seu plano permite no m√°ximo ${lim.maxWindows} janelas.`);return;}
    windowsCount=next;document.getElementById('windowsVal').textContent=windowsCount;hideLimitNotice();
  }else{
    const next=timerSecs+delta;
    if(next<lim.minTimer){showLimitNotice(`Intervalo m√≠nimo do seu plano √© ${lim.minTimer}s.`);return;}
    if(next>3600)return;
    timerSecs=next;document.getElementById('timerVal').textContent=timerSecs;hideLimitNotice();
  }
}

function showLimitNotice(t){const el=document.getElementById('limitNotice');el.textContent='‚ö† '+t;el.style.display='block';clearTimeout(el._h);el._h=setTimeout(hideLimitNotice,4000);}
function hideLimitNotice(){document.getElementById('limitNotice').style.display='none';}

function extractVideoId(url){
  try{
    const u=new URL(url.startsWith('http')?url:'https://'+url);
    if(u.searchParams.get('v'))return u.searchParams.get('v');
    if(u.hostname==='youtu.be')return u.pathname.slice(1).split('?')[0];
    const s=u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/);if(s)return s[1];
    const e=u.pathname.match(/\/embed\/([^/?]+)/);if(e)return e[1];
  }catch(e){}
  const m=url.match(/(?:v=|youtu\.be\/|embed\/|shorts\/)([a-zA-Z0-9_-]{11})/);
  return m?m[1]:null;
}

function buildEmbedUrl(id){return `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&mute=1&controls=1&rel=0&modestbranding=1`;}

function launch(){
  const raw=document.getElementById('urlInput').value.trim();
  if(!raw){alert('Cole um link do YouTube!');return;}
  const vid=extractVideoId(raw);
  if(!vid){alert('Link do YouTube inv√°lido.');return;}
  stopAll(true);buildGrid(vid);startTimer(vid);
}

function buildGrid(videoId){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  const cols=windowsCount<=1?1:windowsCount<=2?2:windowsCount<=4?2:windowsCount<=6?3:windowsCount<=9?3:4;
  grid.style.gridTemplateColumns=`repeat(${cols},1fr)`;
  grid.style.display='grid';
  document.getElementById('emptyState').style.display='none';
  for(let i=0;i<windowsCount;i++){
    const cell=document.createElement('div');cell.className='player-cell';cell.style.animationDelay=(i*0.06)+'s';
    const badge=document.createElement('div');badge.className='cell-badge';badge.textContent=`#${i+1}`;
    const iframe=document.createElement('iframe');
    iframe.src=buildEmbedUrl(videoId);
    iframe.allow='autoplay; encrypted-media; picture-in-picture';
    iframe.allowFullscreen=true;
    cell.appendChild(iframe);cell.appendChild(badge);grid.appendChild(cell);
  }
  document.getElementById('dot').classList.add('live');
  document.getElementById('statusText').textContent=`${windowsCount} player(s) ativos`;
}

function startTimer(videoId){
  remaining=timerSecs;updateBar();
  tickId=setInterval(()=>{remaining--;updateBar();if(remaining<=0){refreshAll(videoId);remaining=timerSecs;}},1000);
}

function refreshAll(videoId){
  refreshTotal++;
  document.querySelectorAll('.player-cell iframe').forEach(iframe=>{
    const src=buildEmbedUrl(videoId);iframe.src='';setTimeout(()=>{iframe.src=src;},80);
  });
  document.getElementById('statusText').textContent=`Refresh #${refreshTotal} ‚Äî ${windowsCount} player(s) atualizados`;
}

function updateBar(){
  document.getElementById('timerbar').style.width=((remaining/timerSecs)*100)+'%';
  document.getElementById('countdown').textContent=remaining>0?`Pr√≥ximo refresh em ${remaining}s`:'';
}

function stopAll(silent=false){
  clearInterval(tickId);tickId=null;
  if(!silent){
    document.getElementById('grid').style.display='none';
    document.getElementById('grid').innerHTML='';
    document.getElementById('emptyState').style.display='flex';
    document.getElementById('dot').classList.remove('live');
    document.getElementById('statusText').textContent='Aguardando URL...';
    document.getElementById('countdown').textContent='';
    document.getElementById('timerbar').style.width='100%';
    refreshTotal=0;
  }
}

document.getElementById('urlInput').addEventListener('keydown',e=>{if(e.key==='Enter')launch();});
</script>
</body>
</html>
